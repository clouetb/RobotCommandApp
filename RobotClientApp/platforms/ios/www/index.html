<!DOCTYPE html>
<html>

<head>

<meta name="keywords" content="JavaScript, WebRTC" />
<meta name="description" content="WebRTC codelab" />
<meta name="viewport" content="user-scalable=no, width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1, minimum-scale=1">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 	data: gap: https://ssl.gstatic.com 'unsafe-eval';
	style-src 'self' 'unsafe-inline'; media-src *; connect-src *">
<title>WebRTC codelab: step 2</title>
	<style>
	body {
		margin-top: 0px;
		margin-left: 0px;
		background-color: #000000;
	}
    #remoteVideos video {
		position: relative;
		top: 0;
		left: 0;
		object-fit: cover;
    }
    #localVideo {
		z-index:1;
		position: absolute;
		top: 20px;
		left: 20px;
/*		object-fit: cover;*/
    }
	</style>
	<script src="js/simplewebrtc.latest.js"></script> 
	<script src="cordova.js"></script>
</head>

<body>

<div style="position: relative; left: 0; top: 0;">
	<div id="remoteVideos"></div>
	<video id="localVideo"></video>
</div>

<script type="text/javascript">

var remoteVideos = window.document.getElementById("remoteVideos");
var localVideo = window.document.getElementById("localVideo");
var savedGeometry = { width: 0, height: 0};

function initDeviceGeometryAndElements()
{
	var angle = window.orientation.toFixed();
	if (angle == 0 || angle == 180) {
		savedGeometry.height = window.document.height;
		savedGeometry.width = window.document.width;
	} else {
		savedGeometry.height = window.document.width;
		savedGeometry.width = window.document.height;
	}
	console.log("Initial video dimensions Remote w " + remoteVideos.width + " h " + remoteVideos.height);
	console.log("Initial video dimensions Local w " + localVideo.width + " h " + localVideo.height);	
}

function resizeVideos(){
	var localImageRatio = .2;
	var angle = window.orientation.toFixed();
	if (angle == 0 || angle == 180) {
		for (var i = 0 ; i < remoteVideos.childNodes.length ; i++){
			remoteVideos.childNodes[i].width = savedGeometry.width;
			remoteVideos.childNodes[i].height = savedGeometry.height;
		}
	} else {
		for (var i = 0 ; i < remoteVideos.childNodes.length ; i++){
			remoteVideos.childNodes[i].width = savedGeometry.height
			remoteVideos.childNodes[i].height = savedGeometry.width;;
		}
	}
	localVideo.width = localVideo.videoWidth * localImageRatio;
	localVideo.height = localVideo.videoHeight * localImageRatio;
	cordova.plugins.iosrtc.refreshVideos();	
	console.log("Video dimensions Remote w " + remoteVideos.width + " h " + remoteVideos.height);
	console.log("Video dimensions Local w " + localVideo.width + " h " + localVideo.height);	
}

window.addEventListener("load", function() {
	console.log("Robot app >>> DOM loaded");

	document.addEventListener("deviceready", function() {

		initDeviceGeometryAndElements();
		resizeVideos();

		window.addEventListener('orientationchange', function() {
			console.log("Robot app >>> Orientation change");
			var iOS = navigator.userAgent.match(/(iPad|iPhone|iPod)/g);
			var viewportmeta = document.querySelector('meta[name="viewport"]');
			if (iOS && viewportmeta) {
				if (viewportmeta.content.match(/width=device-width/)) {
					viewportmeta.content = viewportmeta.content.replace(/width=[^,]+/, 'width=1');
				}
				viewportmeta.content = viewportmeta.content.replace(/width=[^,]+/, 'width=' + window.innerWidth);
			}

			resizeVideos();
			// If you want to hide the address bar on orientation change, uncomment the next line
			// window.scrollTo(0, 0);
		}, false); // End of addEventListener deviceready

		console.log("Robot app >>> deviceready event");

		// if iOS devices
		if (window.device.platform === "iOS") {
			// cordova.plugins.iosrtc.debug.enable("*");

			// Pollute global namespace with WebRTC stuff.
			cordova.plugins.iosrtc.registerGlobals();
			console.log("Robot app >>> Globals registered");
		}

		var webrtc = new SimpleWebRTC({
			// the id/element dom element that will hold "our" video
			localVideoEl: 'localVideo',
			// the id/element dom element that will hold remote videos
			remoteVideosEl: 'remoteVideos',
			// immediately ask for camera access
			autoRequestMedia: true,
			// required for working on my iPhone
			detectSpeakingEvents: false /*,
			debug: true*/
		});

		// we have to wait until it's ready
		webrtc.on('readyToCall', function() {
			// you can name it anything
			webrtc.joinRoom('PrivateRoomForMyRobot_BCL');
		});

		webrtc.on('videoAdded', function (video, peer) {
			console.log('video added', peer);
			resizeVideos();
		});
	}); // End of ondeviceready.
}); // End of onload.

</script>

</body>

</html>